<!-- ============================= -->
<!--   SELECTIVE SYNC MODAL        -->
<!-- ============================= -->
<div id="selective-sync-modal" class="calendar-action-modal">
  <div class="calendar-action-modal-content">
    <div class="calendar-action-modal-header">
      <h2><i class="fas fa-calendar-plus"></i> Sync to Calendar</h2>
      <button id="close-selective-sync-modal" class="close-btn">&times;</button>
    </div>
    
    <div class="calendar-action-modal-body">
      <!-- Sprint Info -->
      <div class="sync-modal-sprint-info">
        <span class="sync-modal-sprint-name" id="sync-modal-sprint-name"></span>
        <span class="sync-modal-date-range" id="sync-modal-date-range"></span>
      </div>
      
      <!-- Warnings Section -->
      <div id="sync-warnings-container" class="sync-warnings-container hidden"></div>
      
      <!-- Quick Actions -->
      <div class="sync-quick-actions">
        <button type="button" class="quick-action-btn" id="sync-select-all"><i class="fas fa-check-double"></i> Select All</button>
        <button type="button" class="quick-action-btn" id="sync-deselect-all"><i class="fas fa-square"></i> Deselect All</button>
        <button type="button" class="quick-action-btn" id="sync-select-formative"><i class="fas fa-book"></i> Formative Only</button>
        <button type="button" class="quick-action-btn" id="sync-select-summative"><i class="fas fa-clipboard-check"></i> Summative Only</button>
      </div>
      
      <!-- Bulk Priority Setter -->
      <div class="sync-bulk-priority">
        <span class="bulk-priority-label">Set all priorities to:</span>
        <button type="button" class="bulk-priority-btn p0" data-priority="P0">P0</button>
        <button type="button" class="bulk-priority-btn p1" data-priority="P1">P1</button>
        <button type="button" class="bulk-priority-btn p2" data-priority="P2">P2</button>
        <button type="button" class="bulk-priority-btn p3" data-priority="P3">P3</button>
      </div>
      
      <!-- Week Selection List -->
      <div class="sync-week-list" id="sync-week-list">
        <!-- Dynamically populated -->
      </div>
      
      <!-- Summary -->
      <div class="sync-summary" id="sync-summary">
        <span class="sync-summary-count"><span id="sync-selected-count">0</span> items selected</span>
      </div>
    </div>
    
    <div class="calendar-action-modal-footer">
      <button type="button" class="modal-btn secondary" id="cancel-selective-sync">Cancel</button>
      <button type="button" class="modal-btn export-blue" id="export-ics-sync"><i class="fas fa-download"></i> Export</button>
      <button type="button" class="modal-btn export-blue" id="update-ics-file"><i class="fas fa-save"></i> Update</button>
      <button type="button" class="modal-btn info" id="preview-sync-changes"><i class="fas fa-eye"></i> Preview</button>
      <button type="button" class="modal-btn primary" id="confirm-selective-sync"><i class="fas fa-sync"></i> Sync</button>
    </div>
  </div>
</div>

<!-- ============================= -->
<!--   SELECTIVE REMOVE MODAL      -->
<!-- ============================= -->
<div id="selective-remove-modal" class="calendar-action-modal">
  <div class="calendar-action-modal-content remove-modal">
    <div class="calendar-action-modal-header">
      <h2><i class="fas fa-calendar-minus"></i> Remove from Calendar</h2>
      <button id="close-selective-remove-modal" class="close-btn">&times;</button>
    </div>
    
    <div class="calendar-action-modal-body">
      <!-- Sprint Info -->
      <div class="sync-modal-sprint-info">
        <span class="sync-modal-sprint-name" id="remove-modal-sprint-name"></span>
        <span class="sync-modal-date-range" id="remove-modal-date-range"></span>
      </div>
      
      <!-- Quick Actions -->
      <div class="sync-quick-actions">
        <button type="button" class="quick-action-btn" id="remove-select-all"><i class="fas fa-check-double"></i> Select All</button>
        <button type="button" class="quick-action-btn" id="remove-deselect-all"><i class="fas fa-square"></i> Deselect All</button>
        <button type="button" class="quick-action-btn" id="remove-select-formative"><i class="fas fa-book"></i> Formative Only</button>
        <button type="button" class="quick-action-btn" id="remove-select-summative"><i class="fas fa-clipboard-check"></i> Summative Only</button>
      </div>
      
      <!-- Week Selection List -->
      <div class="sync-week-list" id="remove-week-list">
        <!-- Dynamically populated -->
      </div>
      
      <!-- Summary -->
      <div class="sync-summary remove-summary" id="remove-summary">
        <span class="sync-summary-count"><span id="remove-selected-count">0</span> items selected for removal</span>
      </div>
    </div>
    
    <div class="calendar-action-modal-footer">
      <button type="button" class="modal-btn secondary" id="cancel-selective-remove">Cancel</button>
      <button type="button" class="modal-btn danger" id="confirm-selective-remove"><i class="fas fa-trash-alt"></i> Remove Selected</button>
    </div>
  </div>
</div>

<!-- ============================= -->
<!--   CALENDAR PREVIEW MODAL       -->
<!-- ============================= -->
<div id="calendar-preview-modal" class="calendar-action-modal">
  <div class="calendar-action-modal-content preview-modal">
    <div class="calendar-action-modal-header">
      <h2><i class="fas fa-eye"></i> Preview Calendar Changes</h2>
      <button id="close-preview-modal" class="close-btn">&times;</button>
    </div>
    
    <div class="calendar-action-modal-body">
      <div class="preview-comparison">
        <div class="preview-column current">
          <h3><i class="fas fa-calendar"></i> Current Calendar</h3>
          <div id="current-events-list" class="preview-events-list">
            <div class="preview-loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
          </div>
        </div>
        
        <div class="preview-column changes">
          <h3><i class="fas fa-arrow-right"></i> Proposed Changes</h3>
          <div id="proposed-changes-list" class="preview-events-list"></div>
        </div>
      </div>
      
      <div class="preview-summary">
        <div class="summary-item add"><i class="fas fa-plus-circle"></i> <span id="add-count">0</span> to add</div>
        <div class="summary-item update"><i class="fas fa-sync-alt"></i> <span id="update-count">0</span> to update</div>
      </div>
    </div>
    
    <div class="calendar-action-modal-footer">
      <button type="button" class="modal-btn secondary" id="preview-back">Back to Selection</button>
      <button type="button" class="modal-btn primary" id="preview-confirm"><i class="fas fa-check"></i> Confirm & Sync</button>
    </div>
  </div>
</div>

<!-- Embed school calendar as application/json to avoid Liquid template lint errors -->
{% assign calendar = site.data.school_calendar %}
<script id="school-calendar-json" type="application/json">
{
  "schoolYear": {{ calendar.school_year | jsonify }},
  "firstDay": {{ calendar.first_day | jsonify }},
  "lastDay": {{ calendar.last_day | jsonify }},
  "weeks": {
    {% for week in calendar.weeks %}
    "{{ week[0] }}": {
      "monday": {{ week[1].monday | jsonify }},
      "friday": {{ week[1].friday | jsonify }},
      "tuesday": {{ week[1].tuesday | default: nil | jsonify }},
      "holidays": {{ week[1].holidays | default: nil | jsonify }},
      "holidayAdjustment": {{ week[1].holiday_adjustment | default: nil | jsonify }},
      "skipWeek": {{ week[1].skip_week | default: false | jsonify }},
      "theme": {{ week[1].theme | default: nil | jsonify }},
      "notes": {{ week[1].notes | default: nil | jsonify }}
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  }
}
</script>

<script>
  // ============================= 
  //   SCHOOL CALENDAR SYSTEM     
  // ============================= 

  // School Calendar data is loaded from JSON script tag to avoid Liquid template lint errors
  let SCHOOL_CALENDAR = {};
  try {
    const calendarEl = document.getElementById('school-calendar-json');
    if (calendarEl && calendarEl.textContent) {
      SCHOOL_CALENDAR = JSON.parse(calendarEl.textContent);
    }
  } catch (e) {
    console.warn('Unable to parse SCHOOL_CALENDAR, falling back to empty object', e);
    SCHOOL_CALENDAR = { weeks: {} };
  }
  
  // Helper function to find the next valid school week (skipping break weeks)
  function getNextValidSchoolWeek(startWeekNum) {
    let weekNum = startWeekNum;
    const maxWeeks = 50; // Safety limit
    while (weekNum < maxWeeks) {
      const week = SCHOOL_CALENDAR.weeks[weekNum];
      if (!week) return null;
      if (!week.skipWeek) return weekNum;
      weekNum++;
    }
    return null;
  }
  
  // Helper function to check if a week is a school day (not a skip week)
  function isSchoolWeek(weekNum) {
    const week = SCHOOL_CALENDAR.weeks[weekNum];
    return week && !week.skipWeek;
  }
  
  const SPRINT_DATES_STORAGE_KEY = 'sprintDates';
  
  // Get calendar week data directly - sprint weeks ARE calendar weeks
  // The skip_week property is used to show warnings, not to remap weeks
  function getCalendarWeek(weekNum) {
    return SCHOOL_CALENDAR.weeks[weekNum] || null;
  }
  
  // Check if a calendar week is a break/skip week
  function isSkipWeek(weekNum) {
    const week = SCHOOL_CALENDAR.weeks[weekNum];
    return week && week.skipWeek === true;
  }
  
  // Get the appropriate date for reading materials (Monday or Tuesday if holiday)
  function getReadingDate(weekNum) {
    const week = SCHOOL_CALENDAR.weeks[weekNum];
    if (!week) return null;
    
    // Skip weeks should not return dates (they're breaks)
    if (week.skipWeek) return null;
    
    // If Monday is a holiday, use Tuesday
    if (week.holidayAdjustment === 'tuesday' && week.tuesday) {
      return week.tuesday;
    }
    return week.monday;
  }
  
  // Get the Friday date for assessments
  function getAssessmentDate(weekNum) {
    const week = SCHOOL_CALENDAR.weeks[weekNum];
    if (!week) return null;
    
    // Skip weeks should not return dates (they're breaks)
    if (week.skipWeek) return null;
    
    return week.friday;
  }
  
  // Get the Tuesday of the NEXT valid school week for checkpoints
  function getCheckpointDate(weekNum) {
    // Find next valid school week after the given week
    let nextWeekNum = weekNum + 1;
    const maxWeeks = 50;
    
    // Skip any break weeks to find the next valid school week
    while (nextWeekNum < maxWeeks) {
      const week = SCHOOL_CALENDAR.weeks[nextWeekNum];
      if (!week) return null;
      if (!week.skipWeek) {
        // Calculate Tuesday from Monday (add 1 day)
        const monday = new Date(week.monday);
        monday.setDate(monday.getDate() + 1);
        return monday.toISOString().split('T')[0];
      }
      nextWeekNum++;
    }
    return null;
  }
  
  // Format date for display
  function formatDateDisplay(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr + 'T00:00:00');
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }
  
  function formatDateShort(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr + 'T00:00:00');
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }
  
  // Get the date range for a sprint based on week numbers
  // Sprint weeks directly correspond to calendar weeks
  function getSprintDateRange(startWeek, endWeek) {
    const startWeekData = SCHOOL_CALENDAR.weeks[startWeek];
    const endWeekData = SCHOOL_CALENDAR.weeks[endWeek];
    
    if (!startWeekData || !endWeekData) {
      return { start: null, end: null };
    }
    
    return {
      start: startWeekData.monday,
      end: endWeekData.friday
    };
  }
  
  // Populate the sprint date preview with actual calendar dates
  function populateSprintDatePreview(sprintKey, startWeek, endWeek) {
    const previewEl = document.querySelector(`.sprint-date-preview[data-sprint="${sprintKey}"]`);
    if (!previewEl) return;
    
    const dateRange = getSprintDateRange(startWeek, endWeek);
    
    let html = '';
    if (dateRange.start && dateRange.end) {
      html = `
        <div class="date-range-display">
          <span class="date-label">Start:</span> 
          <span class="date-value">${formatDateDisplay(dateRange.start)}</span>
        </div>
        <div class="date-range-display">
          <span class="date-label">End:</span> 
          <span class="date-value">${formatDateDisplay(dateRange.end)}</span>
        </div>
      `;
      
      // Show any break weeks that fall within this sprint range
      const breakWeeks = [];
      for (let w = startWeek; w <= endWeek; w++) {
        const week = SCHOOL_CALENDAR.weeks[w];
        if (week && week.skipWeek && week.holidays) {
          breakWeeks.push({ week: w, holidays: week.holidays });
        }
      }
      
      if (breakWeeks.length > 0) {
        html += '<div class="holiday-warnings">';
        breakWeeks.forEach(b => {
          html += `<div class="holiday-notice break"><i class="fas fa-umbrella-beach"></i> Week ${b.week}: ${b.holidays.join(', ')} (no school)</div>`;
        });
        html += '</div>';
      }
      
      // Show holiday warnings (non-skip weeks with holidays - materials on Tuesday)
      const holidays = [];
      for (let w = startWeek; w <= endWeek; w++) {
        const week = SCHOOL_CALENDAR.weeks[w];
        if (week && week.holidays && !week.skipWeek) {
          holidays.push({ week: w, holidays: week.holidays });
        }
      }
      
      if (holidays.length > 0) {
        html += '<div class="holiday-warnings">';
        holidays.forEach(h => {
          html += `<div class="holiday-notice"><i class="fas fa-exclamation-triangle"></i> Week ${h.week}: ${h.holidays.join(', ')} - Materials on Tuesday</div>`;
        });
        html += '</div>';
      }
    } else {
      html = '<div class="date-error">Calendar dates not available for these weeks</div>';
    }
    
    previewEl.innerHTML = html;
  }
  
  // Initialize sprint calendar controls
  async function initializeSprintDates() {
    // Populate all sprint date previews (using advanced-sync-btn as reference)
    document.querySelectorAll('.advanced-sync-btn').forEach(btn => {
      const sprintKey = btn.dataset.sprint;
      const startWeek = parseInt(btn.dataset.startWeek);
      const endWeek = parseInt(btn.dataset.endWeek);
      populateSprintDatePreview(sprintKey, startWeek, endWeek);
    });
    
    // Toggle dropdown visibility
    document.querySelectorAll('.sprint-btn.date-toggle').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const sprintKey = btn.dataset.sprint;
        const dropdown = document.querySelector(`.sprint-date-dropdown[data-sprint="${sprintKey}"]`);
        
        // Close all other dropdowns
        document.querySelectorAll('.sprint-date-dropdown').forEach(d => {
          if (d !== dropdown) d.classList.add('hidden');
        });
        
        dropdown.classList.toggle('hidden');
      });
    });
    
    // Close dropdown buttons
    document.querySelectorAll('.date-dropdown-close').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        btn.closest('.sprint-date-dropdown').classList.add('hidden');
      });
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.sprint-date-control')) {
        document.querySelectorAll('.sprint-date-dropdown').forEach(d => {
          d.classList.add('hidden');
        });
      }
    });
    
    // Sync button handlers - open selective sync modal
    document.querySelectorAll('.advanced-sync-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const sprintKey = btn.dataset.sprint;
        const course = btn.dataset.course;
        const startWeek = parseInt(btn.dataset.startWeek);
        const endWeek = parseInt(btn.dataset.endWeek);
        
        openSelectiveSyncModal(sprintKey, course, startWeek, endWeek);
      });
    });
    
    // Remove button handlers - open selective remove modal
    document.querySelectorAll('.advanced-remove-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const sprintKey = btn.dataset.sprint;
        const course = btn.dataset.course;
        const startWeek = parseInt(btn.dataset.startWeek);
        const endWeek = parseInt(btn.dataset.endWeek);
        
        openSelectiveRemoveModal(sprintKey, course, startWeek, endWeek);
      });
    });
    
    // Initialize selective sync/remove modal handlers
    initializeSelectiveSyncModals();
  }
  
  // Show status message
  function showDateStatus(el, message, type) {
    if (!el) return;
    el.textContent = message;
    el.className = 'sprint-date-status ' + type;
    
    if (type === 'success' || type === 'error' || type === 'warning') {
      setTimeout(() => {
        el.textContent = '';
        el.className = 'sprint-date-status';
      }, 5000);
    }
  }
  
  // Show toast notification (visible overlay message)
  function showToastNotification(message, type) {
    // Remove existing toast if present
    const existingToast = document.querySelector('.calendar-toast-notification');
    if (existingToast) {
      existingToast.remove();
    }
    
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `calendar-toast-notification ${type}`;
    toast.innerHTML = `
      <span class="toast-message">${message}</span>
      <button class="toast-close">&times;</button>
    `;
    
    // Add to page
    document.body.appendChild(toast);
    
    // Trigger animation
    setTimeout(() => toast.classList.add('show'), 10);
    
    // Close button handler
    toast.querySelector('.toast-close').addEventListener('click', () => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    });
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (toast.parentNode) {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }
    }, 5000);
  }

  // ========================================
  // SELECTIVE SYNC/REMOVE MODAL SYSTEM
  // ========================================
  
  let currentSyncModalData = null;
  let currentRemoveModalData = null;
  
  // Parse week items from week card data attributes
  function parseWeekItems(weekCard) {
    const weekNum = parseInt(weekCard.dataset.week);
    const lessons = weekCard.dataset.lessons || '';
    const assignments = weekCard.dataset.assignments || '';
    
    const items = [];
    
    // Parse lessons (formative)
    if (lessons) {
      const lessonList = lessons.split(';;;').filter(l => l.trim());
      const seenTitles = new Set();
      lessonList.forEach(l => {
        const [title, url] = l.split('|||');
        if (!seenTitles.has(title)) {
          seenTitles.add(title);
          items.push({
            id: `w${weekNum}-formative-${title.replace(/\s+/g, '-').toLowerCase()}`,
            title: title,
            url: url,
            type: 'formative',
            weekNum: weekNum,
            day: 'Monday'
          });
        }
      });
    }
    
    // Parse assignments (summative)
    if (assignments) {
      const assignmentList = assignments.split(';;;').filter(a => a.trim());
      const seenTitles = new Set();
      assignmentList.forEach(a => {
        const [title, url] = a.split('|||');
        if (!seenTitles.has(title)) {
          seenTitles.add(title);
          items.push({
            id: `w${weekNum}-summative-${title.replace(/\s+/g, '-').toLowerCase()}`,
            title: title,
            url: url,
            type: 'summative',
            weekNum: weekNum,
            day: 'Friday'
          });
        }
      });
    }
    
    return items;
  }
  
  // Build week selection HTML for modal
  function buildWeekSelectionHTML(sprintKey, course, startWeek, endWeek, modalType) {
    const sprintCard = document.querySelector(`.sprint-card[data-sprint="${sprintKey}"]`);
    const weekCards = sprintCard?.querySelectorAll('.week-card') || [];
    const courseName = course.toUpperCase();
    
    // Load saved item priorities from localStorage
    const ITEM_PRIORITY_KEY = `item_priorities_${window.location.pathname}`;
    let savedPriorities = {};
    try {
      const stored = localStorage.getItem(ITEM_PRIORITY_KEY);
      savedPriorities = stored ? JSON.parse(stored) : {};
    } catch (e) {
      console.warn('Could not load saved priorities:', e);
    }
    
    // Helper to get saved priority for an item
    const getSavedPriority = (url) => savedPriorities[url] || 'P2';
    
    // Helper to build priority options with saved selection
    const buildPriorityOptions = (url) => {
      const saved = getSavedPriority(url);
      return ['P0', 'P1', 'P2', 'P3'].map(p => 
        `<option value="${p}"${p === saved ? ' selected' : ''}>${p}</option>`
      ).join('');
    };
    
    let html = '';
    
    for (const weekCard of weekCards) {
      const weekNum = parseInt(weekCard.dataset.week);
      const items = parseWeekItems(weekCard);
      
      if (items.length === 0) continue;
      
      const formativeItems = items.filter(i => i.type === 'formative');
      const summativeItems = items.filter(i => i.type === 'summative');
      
      const readingDate = getReadingDate(weekNum);
      const assessmentDate = getAssessmentDate(weekNum);
      
      // Check for warnings
      const calendarWeek = SCHOOL_CALENDAR.weeks[weekNum];
      const isSkip = calendarWeek?.skipWeek;
      const hasHoliday = calendarWeek?.holidays && !isSkip;
      const isPastDate = readingDate && new Date(readingDate) < new Date();
      
      html += `
        <div class="sync-week-group" data-week="${weekNum}">
          <div class="sync-week-header">
            <label class="sync-week-checkbox">
              <input type="checkbox" class="week-select-all" data-week="${weekNum}" checked>
              <span class="week-label">
                <strong>Week ${weekNum}</strong>
                <span class="week-date-range">${readingDate ? formatDateShort(readingDate) : ''} - ${assessmentDate ? formatDateShort(assessmentDate) : ''}</span>
              </span>
            </label>
            <button type="button" class="week-expand-btn" data-week="${weekNum}">
              <i class="fas fa-chevron-down"></i>
            </button>
          </div>
          
          ${isSkip ? `<div class="sync-item-warning skip"><i class="fas fa-umbrella-beach"></i> Break week - ${calendarWeek.holidays?.join(', ') || 'No school'}</div>` : ''}
          ${hasHoliday ? `<div class="sync-item-warning holiday"><i class="fas fa-exclamation-triangle"></i> Holiday: ${calendarWeek.holidays?.join(', ')} - Materials on Tuesday</div>` : ''}
          ${isPastDate ? `<div class="sync-item-warning past"><i class="fas fa-clock"></i> This week's dates have already passed</div>` : ''}
          
          <div class="sync-week-items" data-week="${weekNum}">
            ${formativeItems.length > 0 ? `
              <div class="sync-item-category">
                <div class="sync-category-header">
                  <label class="sync-category-checkbox">
                    <input type="checkbox" class="category-select-all" data-week="${weekNum}" data-type="formative" checked>
                    <i class="fas fa-book"></i> Formative (${readingDate ? formatDateShort(readingDate) : 'Monday'})
                  </label>
                </div>
                <div class="sync-item-list">
                  ${formativeItems.map(item => `
                    <label class="sync-item-checkbox">
                      <input type="checkbox" class="item-checkbox" data-week="${weekNum}" data-type="formative" data-id="${item.id}" data-title="${item.title}" data-url="${item.url || ''}" data-default-date="${readingDate || ''}" checked>
                      <span class="item-title">${item.title}</span>
                      <select class="item-priority-select" data-id="${item.id}" data-url="${item.url || ''}">
                        ${buildPriorityOptions(item.url)}
                      </select>
                      <input type="date" class="item-date-input" data-id="${item.id}" value="${readingDate || ''}" title="Custom date (leave as-is to use default)">
                      ${item.url ? `<a href="{{ site.baseurl }}${item.url}" target="_blank" class="item-link-icon" onclick="event.stopPropagation()"><i class="fas fa-external-link-alt"></i></a>` : ''}
                    </label>
                  `).join('')}
                </div>
              </div>
            ` : ''}
            
            ${summativeItems.length > 0 ? `
              <div class="sync-item-category">
                <div class="sync-category-header">
                  <label class="sync-category-checkbox">
                    <input type="checkbox" class="category-select-all" data-week="${weekNum}" data-type="summative" checked>
                    <i class="fas fa-clipboard-check"></i> Summative (${assessmentDate ? formatDateShort(assessmentDate) : 'Friday'})
                  </label>
                </div>
                <div class="sync-item-list">
                  ${summativeItems.map(item => `
                    <label class="sync-item-checkbox">
                      <input type="checkbox" class="item-checkbox" data-week="${weekNum}" data-type="summative" data-id="${item.id}" data-title="${item.title}" data-url="${item.url || ''}" data-default-date="${assessmentDate || ''}" checked>
                      <span class="item-title">${item.title}</span>
                      <select class="item-priority-select" data-id="${item.id}" data-url="${item.url || ''}">
                        ${buildPriorityOptions(item.url)}
                      </select>
                      <input type="date" class="item-date-input" data-id="${item.id}" value="${assessmentDate || ''}" title="Custom date (leave as-is to use default)">
                      ${item.url ? `<a href="{{ site.baseurl }}${item.url}" target="_blank" class="item-link-icon" onclick="event.stopPropagation()"><i class="fas fa-external-link-alt"></i></a>` : ''}
                    </label>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }
    
    return html || '<p class="no-items-message">No items found for this sprint.</p>';
  }
  
  // Open selective sync modal
  function openSelectiveSyncModal(sprintKey, course, startWeek, endWeek) {
    currentSyncModalData = { sprintKey, course, startWeek, endWeek };
    
    const sprintCard = document.querySelector(`.sprint-card[data-sprint="${sprintKey}"]`);
    const sprintTitle = sprintCard?.querySelector('.sprint-title')?.textContent || sprintKey;
    const courseName = course.toUpperCase();
    
    // Set header info
    document.getElementById('sync-modal-sprint-name').textContent = `${sprintTitle} - ${courseName}`;
    const dateRange = getSprintDateRange(startWeek, endWeek);
    document.getElementById('sync-modal-date-range').textContent = 
      dateRange.start && dateRange.end 
        ? `${formatDateDisplay(dateRange.start)} - ${formatDateDisplay(dateRange.end)}`
        : `Weeks ${startWeek}-${endWeek}`;
    
    // Build week selection list
    document.getElementById('sync-week-list').innerHTML = buildWeekSelectionHTML(sprintKey, course, startWeek, endWeek, 'sync');
    
    // Check for existing events and show warnings
    checkForExistingEvents(sprintKey, course, startWeek, endWeek);
    
    // Initialize checkbox handlers for this modal
    initializeSyncModalCheckboxes('sync');
    
    // Update count
    updateSelectedCount('sync');
    
    // Close the dropdown
    document.querySelectorAll('.sprint-date-dropdown').forEach(d => d.classList.add('hidden'));
    
    // Show modal
    document.getElementById('selective-sync-modal').style.display = 'flex';
  }
  
  // Open selective remove modal
  function openSelectiveRemoveModal(sprintKey, course, startWeek, endWeek) {
    currentRemoveModalData = { sprintKey, course, startWeek, endWeek };
    
    const sprintCard = document.querySelector(`.sprint-card[data-sprint="${sprintKey}"]`);
    const sprintTitle = sprintCard?.querySelector('.sprint-title')?.textContent || sprintKey;
    const courseName = course.toUpperCase();
    
    // Set header info
    document.getElementById('remove-modal-sprint-name').textContent = `${sprintTitle} - ${courseName}`;
    const dateRange = getSprintDateRange(startWeek, endWeek);
    document.getElementById('remove-modal-date-range').textContent = 
      dateRange.start && dateRange.end 
        ? `${formatDateDisplay(dateRange.start)} - ${formatDateDisplay(dateRange.end)}`
        : `Weeks ${startWeek}-${endWeek}`;
    
    // Build week selection list
    document.getElementById('remove-week-list').innerHTML = buildWeekSelectionHTML(sprintKey, course, startWeek, endWeek, 'remove');
    
    // Initialize checkbox handlers for this modal
    initializeSyncModalCheckboxes('remove');
    
    // Update count
    updateSelectedCount('remove');
    
    // Close the dropdown
    document.querySelectorAll('.sprint-date-dropdown').forEach(d => d.classList.add('hidden'));
    
    // Show modal
    document.getElementById('selective-remove-modal').style.display = 'flex';
  }
  
  // Check for existing events on the calendar
  async function checkForExistingEvents(sprintKey, course, startWeek, endWeek) {
    const warningsContainer = document.getElementById('sync-warnings-container');
    warningsContainer.innerHTML = '<div class="checking-events"><i class="fas fa-spinner fa-spin"></i> Checking for existing events...</div>';
    warningsContainer.classList.remove('hidden');
    
    try {
      const configModule = await import('{{ site.baseurl }}/assets/js/api/config.js');
      const javaURI = configModule.javaURI;
      const courseName = course.toUpperCase();
      
      // Build list of event titles we're about to sync
      const eventTitlesToCheck = [];
      const priorities = ['P0', 'P1', 'P2', 'P3'];
      
      for (let weekNum = startWeek; weekNum <= endWeek; weekNum++) {
        priorities.forEach(p => {
          eventTitlesToCheck.push(`[${p}] üìö Week ${weekNum} Formative - ${courseName}`);
          eventTitlesToCheck.push(`[${p}] üìù Week ${weekNum} Summative - ${courseName}`);
        });
        // Also check old format
        eventTitlesToCheck.push(`üìö Week ${weekNum} Formative - ${courseName}`);
        eventTitlesToCheck.push(`üìù Week ${weekNum} Summative - ${courseName}`);
      }
      
      // Note: Duplicate checking not available - events will be created/updated as needed
      // The backend handles duplicates by matching on title and date
      warningsContainer.innerHTML = '';
      warningsContainer.classList.add('hidden');
    } catch (error) {
      console.log('Could not check for existing events:', error);
      warningsContainer.innerHTML = '';
      warningsContainer.classList.add('hidden');
    }
  }
  
  // Initialize checkbox event handlers within modal
  function initializeSyncModalCheckboxes(modalType) {
    const listId = modalType === 'sync' ? 'sync-week-list' : 'remove-week-list';
    const listEl = document.getElementById(listId);
    
    // Week expand/collapse
    listEl.querySelectorAll('.week-expand-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const weekNum = btn.dataset.week;
        const itemsContainer = listEl.querySelector(`.sync-week-items[data-week="${weekNum}"]`);
        const icon = btn.querySelector('i');
        
        if (itemsContainer.classList.contains('collapsed')) {
          itemsContainer.classList.remove('collapsed');
          icon.classList.remove('fa-chevron-right');
          icon.classList.add('fa-chevron-down');
        } else {
          itemsContainer.classList.add('collapsed');
          icon.classList.remove('fa-chevron-down');
          icon.classList.add('fa-chevron-right');
        }
      });
    });
    
    // Week select all checkbox
    listEl.querySelectorAll('.week-select-all').forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const weekNum = checkbox.dataset.week;
        const isChecked = checkbox.checked;
        
        // Update all items in this week
        listEl.querySelectorAll(`.item-checkbox[data-week="${weekNum}"]`).forEach(cb => {
          cb.checked = isChecked;
        });
        
        // Update category checkboxes
        listEl.querySelectorAll(`.category-select-all[data-week="${weekNum}"]`).forEach(cb => {
          cb.checked = isChecked;
        });
        
        updateSelectedCount(modalType);
      });
    });
    
    // Category select all checkbox
    listEl.querySelectorAll('.category-select-all').forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const weekNum = checkbox.dataset.week;
        const type = checkbox.dataset.type;
        const isChecked = checkbox.checked;
        
        // Update all items in this category
        listEl.querySelectorAll(`.item-checkbox[data-week="${weekNum}"][data-type="${type}"]`).forEach(cb => {
          cb.checked = isChecked;
        });
        
        // Update week checkbox
        updateWeekCheckboxState(listEl, weekNum);
        updateSelectedCount(modalType);
      });
    });
    
    // Individual item checkbox
    listEl.querySelectorAll('.item-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const weekNum = checkbox.dataset.week;
        const type = checkbox.dataset.type;
        
        // Update category checkbox
        updateCategoryCheckboxState(listEl, weekNum, type);
        
        // Update week checkbox
        updateWeekCheckboxState(listEl, weekNum);
        
        updateSelectedCount(modalType);
      });
    });
    
    // Prevent date inputs from triggering label clicks
    listEl.querySelectorAll('.item-date-input').forEach(input => {
      input.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    });
    
    // Prevent priority selects from triggering label clicks  
    listEl.querySelectorAll('.item-priority-select').forEach(select => {
      select.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    });
  }
  
  // Update category checkbox state based on items
  function updateCategoryCheckboxState(listEl, weekNum, type) {
    const categoryCheckbox = listEl.querySelector(`.category-select-all[data-week="${weekNum}"][data-type="${type}"]`);
    if (!categoryCheckbox) return;
    
    const items = listEl.querySelectorAll(`.item-checkbox[data-week="${weekNum}"][data-type="${type}"]`);
    const checkedItems = listEl.querySelectorAll(`.item-checkbox[data-week="${weekNum}"][data-type="${type}"]:checked`);
    
    categoryCheckbox.checked = checkedItems.length === items.length;
    categoryCheckbox.indeterminate = checkedItems.length > 0 && checkedItems.length < items.length;
  }
  
  // Update week checkbox state based on all items
  function updateWeekCheckboxState(listEl, weekNum) {
    const weekCheckbox = listEl.querySelector(`.week-select-all[data-week="${weekNum}"]`);
    if (!weekCheckbox) return;
    
    const items = listEl.querySelectorAll(`.item-checkbox[data-week="${weekNum}"]`);
    const checkedItems = listEl.querySelectorAll(`.item-checkbox[data-week="${weekNum}"]:checked`);
    
    weekCheckbox.checked = checkedItems.length === items.length;
    weekCheckbox.indeterminate = checkedItems.length > 0 && checkedItems.length < items.length;
  }
  
  // Update selected count display
  function updateSelectedCount(modalType) {
    const listId = modalType === 'sync' ? 'sync-week-list' : 'remove-week-list';
    const countId = modalType === 'sync' ? 'sync-selected-count' : 'remove-selected-count';
    
    const listEl = document.getElementById(listId);
    const checkedItems = listEl.querySelectorAll('.item-checkbox:checked');
    
    document.getElementById(countId).textContent = checkedItems.length;
  }
  
  // Get selected items from modal
  function getSelectedItems(modalType) {
    const listId = modalType === 'sync' ? 'sync-week-list' : 'remove-week-list';
    const listEl = document.getElementById(listId);
    
    const selectedItems = [];
    
    listEl.querySelectorAll('.item-checkbox:checked').forEach(checkbox => {
      const weekNum = parseInt(checkbox.dataset.week);
      const type = checkbox.dataset.type;
      const title = checkbox.dataset.title;
      const url = checkbox.dataset.url;
      const itemId = checkbox.dataset.id;
      const defaultDate = checkbox.dataset.defaultDate;
      
      // Get the individual priority for this item
      const prioritySelect = listEl.querySelector(`.item-priority-select[data-id="${itemId}"]`);
      const priority = prioritySelect?.value || 'P2';
      
      // Get the custom date (if user changed it) or use default
      const dateInput = listEl.querySelector(`.item-date-input[data-id="${itemId}"]`);
      const customDate = dateInput?.value || defaultDate;
      
      selectedItems.push({
        weekNum,
        type,
        title,
        url,
        priority,
        customDate
      });
    });
    
    return selectedItems;
  }
  
  // Execute selective sync
  async function executeSelectiveSync() {
    if (!currentSyncModalData) return;
    
    const { sprintKey, course, startWeek, endWeek } = currentSyncModalData;
    const selectedItems = getSelectedItems('sync');
    
    const courseName = course.toUpperCase();
    const confirmBtn = document.getElementById('confirm-selective-sync');
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
    
    try {
      const configModule = await import('{{ site.baseurl }}/assets/js/api/config.js');
      const javaURI = configModule.javaURI;
      const fetchOptions = { ...configModule.fetchOptions, redirect: 'manual' };
      
      const events = [];
      
      // Create individual events for each item with its own priority and custom date
      selectedItems.forEach(item => {
        const { weekNum, type, title, url, priority, customDate } = item;
        
        // Use custom date if provided, otherwise fall back to calculated date
        let eventDate = customDate;
        let emoji;
        let typeLabel;
        
        if (type === 'formative') {
          if (!eventDate) eventDate = getReadingDate(weekNum);
          emoji = 'üìö';
          typeLabel = 'Formative';
        } else {
          if (!eventDate) eventDate = getAssessmentDate(weekNum);
          emoji = 'üìù';
          typeLabel = 'Summative';
        }
        
        if (!eventDate) return;
        
        const fullUrl = url ? window.location.origin + '{{ site.baseurl }}' + url : '';
        
        events.push({
          title: `[${priority}] ${emoji} ${title} - ${courseName}`,
          description: `${typeLabel} - Week ${weekNum}\n${fullUrl}`,
          date: eventDate,
          period: courseName,
          priority: priority
        });
      });
      
      if (events.length === 0) {
        alert('No items selected to sync.');
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fas fa-sync"></i> Sync Selected';
        return;
      }
      
      console.log(`Syncing ${events.length} individual events to calendar`);
      
      let successCount = 0;
      let authFailed = false;
      
      // Send individual requests in parallel
      const results = await Promise.all(
        events.map(event => 
          fetch(`${javaURI}/api/calendar/add_event`, {
            ...fetchOptions,
            method: 'POST',
            body: JSON.stringify(event)
          }).then(res => {
            if (res.type === 'opaqueredirect' || res.status === 0 || res.status === 401 || res.status === 403 || (res.redirected && res.url.includes('/login'))) {
              authFailed = true;
              return false;
            }
            return res.ok;
          }).catch(() => false)
        )
      );
      
      if (authFailed) {
        alert('Your session has expired. Please log in again.');
        window.location.href = '{{ site.baseurl }}/login';
        return;
      }
      successCount = results.filter(r => r).length;
      
      // Close modal and show status
      closeSelectiveSyncModal();
      
      // Show toast notification for visibility
      if (successCount === events.length) {
        showToastNotification(`‚úì Synced ${successCount} events to calendar!`, 'success');
      } else if (successCount > 0) {
        showToastNotification(`‚ö† Synced ${successCount}/${events.length} events`, 'warning');
      } else {
        showToastNotification('‚úó Failed to sync events. Are you logged in?', 'error');
      }
      
      // Also update the dropdown status (visible when dropdown is opened)
      const statusEl = document.querySelector(`.sprint-date-status[data-sprint="${sprintKey}"]`);
      if (successCount === events.length) {
        showDateStatus(statusEl, `‚úì Synced ${successCount} events to calendar!`, 'success');
      } else if (successCount > 0) {
        showDateStatus(statusEl, `‚ö† Synced ${successCount}/${events.length} events`, 'warning');
      } else {
        showDateStatus(statusEl, '‚úó Failed to sync events. Are you logged in?', 'error');
      }
      
    } catch (error) {
      console.error('Error syncing:', error);
      alert('Error syncing to calendar. Please try again.');
    } finally {
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '<i class="fas fa-sync"></i> Sync Selected';
    }
  }
  
  // Execute selective remove
  async function executeSelectiveRemove() {
    if (!currentRemoveModalData) return;
    
    const { sprintKey, course, startWeek, endWeek } = currentRemoveModalData;
    const selectedItems = getSelectedItems('remove');
    const courseName = course.toUpperCase();
    
    const confirmBtn = document.getElementById('confirm-selective-remove');
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Removing...';
    
    try {
      const configModule = await import('{{ site.baseurl }}/assets/js/api/config.js');
      const javaURI = configModule.javaURI;
      const fetchOptions = { ...configModule.fetchOptions, redirect: 'manual' };
      
      const titlesToDelete = [];
      const priorities = ['P0', 'P1', 'P2', 'P3'];
      
      // Build titles to delete based on selected items - must match sync format exactly
      selectedItems.forEach(item => {
        const emoji = item.type === 'formative' ? 'üìö' : 'üìù';
        
        // Try all priority variations since we don't know what priority was used when syncing
        priorities.forEach(p => {
          titlesToDelete.push(`[${p}] ${emoji} ${item.title} - ${courseName}`);
        });
        // Also try without priority prefix (in case it was synced without priority)
        titlesToDelete.push(`${emoji} ${item.title} - ${courseName}`);
      });
      
      if (titlesToDelete.length === 0) {
        alert('No items selected to remove.');
        return;
      }
      
      console.log(`Removing events matching ${titlesToDelete.length} title patterns from calendar`);
      
      let deletedCount = 0;
      
      // Strategy: fetch all events, match by title, then delete by ID.
      // This is reliable because the backend's confirmed endpoint is
      // DELETE /api/calendar/delete_event/{id}.
      try {
        const eventsResponse = await fetch(`${javaURI}/api/calendar/events`, fetchOptions);
        if (eventsResponse.type === 'opaqueredirect' || eventsResponse.status === 0 || eventsResponse.status === 401 || eventsResponse.status === 403 || (eventsResponse.redirected && eventsResponse.url.includes('/login'))) {
          alert('Your session has expired. Please log in again.');
          window.location.href = '{{ site.baseurl }}/login';
          return;
        }
        if (!eventsResponse.ok) {
          throw new Error('Could not fetch events to match for deletion');
        }
        const allEvents = await eventsResponse.json();
        
        // Find events whose titles match any of the titles we want to delete
        const eventsToDelete = allEvents.filter(e => titlesToDelete.includes(e.title));
        
        if (eventsToDelete.length === 0) {
          console.log('No matching events found on calendar');
        } else {
          const deleteResults = await Promise.all(
            eventsToDelete.map(event =>
              fetch(`${javaURI}/api/calendar/delete_event/${event.id}`, {
                ...fetchOptions,
                method: 'DELETE'
              }).then(res => res.ok ? 1 : 0).catch(() => 0)
            )
          );
          deletedCount = deleteResults.reduce((a, b) => a + b, 0);
        }
      } catch (fetchErr) {
        console.error('Error during fetch-and-delete:', fetchErr);
        // Fallback: try bulk delete endpoint in case backend supports it
        try {
          const bulkResponse = await fetch(`${javaURI}/api/calendar/delete_events`, {
            ...fetchOptions,
            method: 'DELETE',
            body: JSON.stringify({ titles: titlesToDelete })
          });
          if (bulkResponse.ok) {
            const result = await bulkResponse.json();
            deletedCount = result.deleted || 0;
          }
        } catch (bulkErr) {
          console.error('Bulk delete fallback also failed:', bulkErr);
        }
      }
      
      // Close modal and show status
      closeSelectiveRemoveModal();
      
      // Show toast notification for visibility
      if (deletedCount > 0) {
        showToastNotification(`‚úì Removed ${deletedCount} events from calendar!`, 'success');
      } else {
        showToastNotification('‚ö† No events found to remove', 'warning');
      }
      
      // Also update the dropdown status (visible when dropdown is opened)
      const statusEl = document.querySelector(`.sprint-date-status[data-sprint="${sprintKey}"]`);
      if (deletedCount > 0) {
        showDateStatus(statusEl, `‚úì Removed ${deletedCount} events from calendar!`, 'success');
      } else {
        showDateStatus(statusEl, '‚ö† No events found to remove', 'warning');
      }
      
    } catch (error) {
      console.error('Error removing:', error);
      alert('Error removing from calendar. Please try again.');
    } finally {
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Remove Selected';
    }
  }
  
  // Close modals
  function closeSelectiveSyncModal() {
    document.getElementById('selective-sync-modal').style.display = 'none';
    currentSyncModalData = null;
  }
  
  function closeSelectiveRemoveModal() {
    document.getElementById('selective-remove-modal').style.display = 'none';
    currentRemoveModalData = null;
  }
  
  // ===========================
  // HELPER: Build events from selected items
  // ===========================
  function buildEventsFromSelection(selectedItems, priority, courseName) {
    const events = [];
    
    Object.keys(selectedItems).forEach(weekNum => {
      const weekData = selectedItems[weekNum];
      const readingDate = getReadingDate(parseInt(weekNum));
      const assessmentDate = getAssessmentDate(parseInt(weekNum));
      
      // Build formative event
      if (weekData.formative && weekData.formative.length > 0 && readingDate) {
        const lessonItems = weekData.formative.map(item => {
          const fullUrl = item.url ? window.location.origin + '{{ site.baseurl }}' + item.url : '';
          return `‚Ä¢ ${item.title}${fullUrl ? '\n  ' + fullUrl : ''}`;
        }).join('\n\n');
        
        events.push({
          title: `[${priority}] üìö Week ${weekNum} Formative - ${courseName}`,
          description: `Reading Materials:\n\n${lessonItems}`,
          date: readingDate,
          period: courseName,
          priority: priority,
          weekNum: parseInt(weekNum),
          type: 'formative'
        });
      }
      
      // Build summative event
      if (weekData.summative && weekData.summative.length > 0 && assessmentDate) {
        const assignmentItems = weekData.summative.map(item => {
          const fullUrl = item.url ? window.location.origin + '{{ site.baseurl }}' + item.url : '';
          return `‚Ä¢ ${item.title}${fullUrl ? '\n  ' + fullUrl : ''}`;
        }).join('\n\n');
        
        events.push({
          title: `[${priority}] üìù Week ${weekNum} Summative - ${courseName}`,
          description: `Assessments Due:\n\n${assignmentItems}`,
          date: assessmentDate,
          period: courseName,
          priority: priority,
          weekNum: parseInt(weekNum),
          type: 'summative'
        });
      }
    });
    
    return events;
  }
  
  // ===========================
  // iCAL EXPORT FUNCTIONS
  // ===========================
  function generateICSFile(events) {
    const icsLines = [
      'BEGIN:VCALENDAR',
      'VERSION:2.0',
      'PRODID:-//School Calendar//Sprint Events//EN',
      'CALSCALE:GREGORIAN',
      'METHOD:PUBLISH',
      'X-WR-CALNAME:Sprint Events'
    ];
    
    events.forEach(event => {
      const uid = `${event.date}-${event.title.replace(/\s+/g, '-')}@school.edu`;
      const dtstamp = formatICSDateTime(new Date());
      const dtstart = formatICSDate(event.date);
      
      icsLines.push('BEGIN:VEVENT');
      icsLines.push(`UID:${uid}`);
      icsLines.push(`DTSTAMP:${dtstamp}`);
      icsLines.push(`DTSTART;VALUE=DATE:${dtstart}`);
      icsLines.push(`SUMMARY:${escapeICS(event.title)}`);
      icsLines.push(`DESCRIPTION:${escapeICS(event.description)}`);
      if (event.period) {
        icsLines.push(`CATEGORIES:${escapeICS(event.period)}`);
      }
      icsLines.push('END:VEVENT');
    });
    
    icsLines.push('END:VCALENDAR');
    
    return icsLines.join('\r\n');
  }
  
  function formatICSDate(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}${month}${day}`;
  }
  
  function formatICSDateTime(date) {
    const year = date.getUTCFullYear();
    const month = String(date.getUTCMonth() + 1).padStart(2, '0');
    const day = String(date.getUTCDate()).padStart(2, '0');
    const hour = String(date.getUTCHours()).padStart(2, '0');
    const minute = String(date.getUTCMinutes()).padStart(2, '0');
    const second = String(date.getUTCSeconds()).padStart(2, '0');
    return `${year}${month}${day}T${hour}${minute}${second}Z`;
  }
  
  function escapeICS(text) {
    if (!text) return '';
    return text
      .replace(/\\/g, '\\\\')
      .replace(/;/g, '\\;')
      .replace(/,/g, '\\,')
      .replace(/\n/g, '\\n');
  }
  
  function downloadICSFile(icsContent, filename) {
    const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }
  
  // ===========================
  // PREVIEW MODAL FUNCTIONS
  // ===========================
  function getSelectedItemsFromModal() {
    const selectedItems = {};
    const listEl = document.getElementById('sync-week-list');
    
    // Use correct selector: .sync-week-group (not .sync-week-item)
    listEl.querySelectorAll('.sync-week-group').forEach(weekGroup => {
      const weekNum = weekGroup.dataset.week;
      const checkboxes = weekGroup.querySelectorAll('.item-checkbox:checked');
      
      if (checkboxes.length > 0) {
        selectedItems[weekNum] = { formative: [], summative: [] };
        
        checkboxes.forEach(cb => {
          // Build item data from individual data attributes (not data-item JSON)
          const itemData = {
            title: cb.dataset.title,
            url: cb.dataset.url || '',
            id: cb.dataset.id
          };
          if (cb.dataset.type === 'formative') {
            selectedItems[weekNum].formative.push(itemData);
          } else {
            selectedItems[weekNum].summative.push(itemData);
          }
        });
      }
    });
    
    return selectedItems;
  }
  
  async function showCalendarPreview() {
    if (!currentSyncModalData) return;
    
    const { sprintKey, course } = currentSyncModalData;
    const selectedItems = getSelectedItemsFromModal();
    const priority = document.querySelector('input[name="sync-modal-priority"]:checked')?.value || 'P2';
    const courseName = course.toUpperCase();
    
    if (Object.keys(selectedItems).length === 0) {
      alert('No items selected to preview.');
      return;
    }
    
    // Hide sync modal, show preview modal
    document.getElementById('selective-sync-modal').style.display = 'none';
    document.getElementById('calendar-preview-modal').style.display = 'flex';
    
    // Populate preview
    await populateCalendarPreview(selectedItems, priority, courseName);
  }
  
  async function populateCalendarPreview(selectedItems, priority, courseName) {
    const currentList = document.getElementById('current-events-list');
    const proposedList = document.getElementById('proposed-changes-list');
    
    let currentEvents = [];
    let fetchError = false;
    
    // Try to fetch current calendar events (optional - preview works without it)
    try {
      const configModule = await import('{{ site.baseurl }}/assets/js/api/config.js');
      const javaURI = configModule.javaURI;
      const fetchOptions = { ...configModule.fetchOptions, redirect: 'manual' };
      
      if (javaURI) {
        const response = await fetch(`${javaURI}/api/calendar/events`, fetchOptions);
        if (response.type === 'opaqueredirect' || response.status === 0 || response.status === 401 || response.status === 403 || (response.redirected && response.url.includes('/login'))) {
          console.warn('Session expired during calendar preview fetch');
          fetchError = true;
        } else if (response.ok) {
          const allEvents = await response.json();
          currentEvents = allEvents.filter(e => e.period === courseName);
        } else {
          fetchError = true;
        }
      } else {
        fetchError = true;
      }
    } catch (e) {
      console.warn('Could not fetch existing calendar events:', e);
      fetchError = true;
    }
    
    // Build proposed events (this part doesn't need the API)
    const proposedEvents = buildEventsFromSelection(selectedItems, priority, courseName);
    
    // Categorize
    const toAdd = [];
    const toUpdate = [];
    
    proposedEvents.forEach(proposed => {
      const existing = currentEvents.find(e => 
          e.title.includes(`Week ${proposed.weekNum}`) && 
          e.title.includes(proposed.type === 'formative' ? 'Formative' : 'Summative') &&
          e.title.includes(courseName)
        );
        
        if (existing) {
          toUpdate.push({ ...proposed, status: 'update', existingId: existing.id });
        } else {
          toAdd.push({ ...proposed, status: 'add' });
        }
      });
      
      // Display current events
      if (fetchError) {
        currentList.innerHTML = '<p class="no-events"><i class="fas fa-exclamation-triangle"></i> Could not load current calendar (not logged in or API unavailable)</p>';
      } else if (currentEvents.length === 0) {
        currentList.innerHTML = '<p class="no-events">No events currently on calendar for this course</p>';
      } else {
        currentList.innerHTML = currentEvents
          .sort((a, b) => new Date(a.date) - new Date(b.date))
          .map(e => `
            <div class="preview-event-item current">
              <div class="event-title">${e.title}</div>
              <div class="event-date">${formatDateDisplay(e.date)}</div>
            </div>
          `).join('');
      }
      
      // Display proposed changes
      if (toAdd.length === 0 && toUpdate.length === 0) {
        proposedList.innerHTML = '<p class="no-events">No changes to make</p>';
      } else {
        const addHTML = toAdd.map(e => `
          <div class="preview-event-item add">
            <div class="event-status"><i class="fas fa-plus-circle"></i> ADD</div>
            <div class="event-title">${e.title}</div>
            <div class="event-date">${formatDateDisplay(e.date)}</div>
            <div class="event-description-preview">${e.description.substring(0, 100)}...</div>
          </div>
        `).join('');
        
        const updateHTML = toUpdate.map(e => `
          <div class="preview-event-item update">
            <div class="event-status"><i class="fas fa-sync-alt"></i> UPDATE</div>
            <div class="event-title">${e.title}</div>
            <div class="event-date">${formatDateDisplay(e.date)}</div>
            <div class="event-description-preview">${e.description.substring(0, 100)}...</div>
          </div>
        `).join('');
        
        proposedList.innerHTML = addHTML + updateHTML;
      }
      
      // Update counts
      document.getElementById('add-count').textContent = toAdd.length;
      document.getElementById('update-count').textContent = toUpdate.length;
  }
  
  function closePreviewModal() {
    document.getElementById('calendar-preview-modal').style.display = 'none';
    document.getElementById('selective-sync-modal').style.display = 'flex';
  }




  
  // Initialize modal event handlers
  function initializeSelectiveSyncModals() {
    // Close buttons
    document.getElementById('close-selective-sync-modal')?.addEventListener('click', closeSelectiveSyncModal);
    document.getElementById('cancel-selective-sync')?.addEventListener('click', closeSelectiveSyncModal);
    document.getElementById('close-selective-remove-modal')?.addEventListener('click', closeSelectiveRemoveModal);
    document.getElementById('cancel-selective-remove')?.addEventListener('click', closeSelectiveRemoveModal);
    
    // Confirm buttons
    document.getElementById('confirm-selective-sync')?.addEventListener('click', executeSelectiveSync);
    document.getElementById('confirm-selective-remove')?.addEventListener('click', executeSelectiveRemove);
    
    // Quick action buttons - Sync modal
    document.getElementById('sync-select-all')?.addEventListener('click', () => {
      document.querySelectorAll('#sync-week-list .item-checkbox').forEach(cb => cb.checked = true);
      document.querySelectorAll('#sync-week-list .category-select-all').forEach(cb => { cb.checked = true; cb.indeterminate = false; });
      document.querySelectorAll('#sync-week-list .week-select-all').forEach(cb => { cb.checked = true; cb.indeterminate = false; });
      updateSelectedCount('sync');
    });
    
    document.getElementById('sync-deselect-all')?.addEventListener('click', () => {
      document.querySelectorAll('#sync-week-list .item-checkbox').forEach(cb => cb.checked = false);
      document.querySelectorAll('#sync-week-list .category-select-all').forEach(cb => { cb.checked = false; cb.indeterminate = false; });
      document.querySelectorAll('#sync-week-list .week-select-all').forEach(cb => { cb.checked = false; cb.indeterminate = false; });
      updateSelectedCount('sync');
    });
    
    document.getElementById('sync-select-formative')?.addEventListener('click', () => {
      document.querySelectorAll('#sync-week-list .item-checkbox[data-type="formative"]').forEach(cb => cb.checked = true);
      document.querySelectorAll('#sync-week-list .item-checkbox[data-type="summative"]').forEach(cb => cb.checked = false);
      document.querySelectorAll('#sync-week-list .category-select-all[data-type="formative"]').forEach(cb => { cb.checked = true; cb.indeterminate = false; });
      document.querySelectorAll('#sync-week-list .category-select-all[data-type="summative"]').forEach(cb => { cb.checked = false; cb.indeterminate = false; });
      document.querySelectorAll('#sync-week-list .week-select-all').forEach(cb => {
        const weekNum = cb.dataset.week;
        updateWeekCheckboxState(document.getElementById('sync-week-list'), weekNum);
      });
      updateSelectedCount('sync');
    });
    
    document.getElementById('sync-select-summative')?.addEventListener('click', () => {
      document.querySelectorAll('#sync-week-list .item-checkbox[data-type="summative"]').forEach(cb => cb.checked = true);
      document.querySelectorAll('#sync-week-list .item-checkbox[data-type="formative"]').forEach(cb => cb.checked = false);
      document.querySelectorAll('#sync-week-list .category-select-all[data-type="summative"]').forEach(cb => { cb.checked = true; cb.indeterminate = false; });
      document.querySelectorAll('#sync-week-list .category-select-all[data-type="formative"]').forEach(cb => { cb.checked = false; cb.indeterminate = false; });
      document.querySelectorAll('#sync-week-list .week-select-all').forEach(cb => {
        const weekNum = cb.dataset.week;
        updateWeekCheckboxState(document.getElementById('sync-week-list'), weekNum);
      });
      updateSelectedCount('sync');
    });
    
    // Quick action buttons - Remove modal
    document.getElementById('remove-select-all')?.addEventListener('click', () => {
      document.querySelectorAll('#remove-week-list .item-checkbox').forEach(cb => cb.checked = true);
      document.querySelectorAll('#remove-week-list .category-select-all').forEach(cb => { cb.checked = true; cb.indeterminate = false; });
      document.querySelectorAll('#remove-week-list .week-select-all').forEach(cb => { cb.checked = true; cb.indeterminate = false; });
      updateSelectedCount('remove');
    });
    
    document.getElementById('remove-deselect-all')?.addEventListener('click', () => {
      document.querySelectorAll('#remove-week-list .item-checkbox').forEach(cb => cb.checked = false);
      document.querySelectorAll('#remove-week-list .category-select-all').forEach(cb => { cb.checked = false; cb.indeterminate = false; });
      document.querySelectorAll('#remove-week-list .week-select-all').forEach(cb => { cb.checked = false; cb.indeterminate = false; });
      updateSelectedCount('remove');
    });
    
    document.getElementById('remove-select-formative')?.addEventListener('click', () => {
      document.querySelectorAll('#remove-week-list .item-checkbox[data-type="formative"]').forEach(cb => cb.checked = true);
      document.querySelectorAll('#remove-week-list .item-checkbox[data-type="summative"]').forEach(cb => cb.checked = false);
      document.querySelectorAll('#remove-week-list .category-select-all[data-type="formative"]').forEach(cb => { cb.checked = true; cb.indeterminate = false; });
      document.querySelectorAll('#remove-week-list .category-select-all[data-type="summative"]').forEach(cb => { cb.checked = false; cb.indeterminate = false; });
      document.querySelectorAll('#remove-week-list .week-select-all').forEach(cb => {
        const weekNum = cb.dataset.week;
        updateWeekCheckboxState(document.getElementById('remove-week-list'), weekNum);
      });
      updateSelectedCount('remove');
    });
    
    document.getElementById('remove-select-summative')?.addEventListener('click', () => {
      document.querySelectorAll('#remove-week-list .item-checkbox[data-type="summative"]').forEach(cb => cb.checked = true);
      document.querySelectorAll('#remove-week-list .item-checkbox[data-type="formative"]').forEach(cb => cb.checked = false);
      document.querySelectorAll('#remove-week-list .category-select-all[data-type="summative"]').forEach(cb => { cb.checked = true; cb.indeterminate = false; });
      document.querySelectorAll('#remove-week-list .category-select-all[data-type="formative"]').forEach(cb => { cb.checked = false; cb.indeterminate = false; });
      document.querySelectorAll('#remove-week-list .week-select-all').forEach(cb => {
        const weekNum = cb.dataset.week;
        updateWeekCheckboxState(document.getElementById('remove-week-list'), weekNum);
      });
      updateSelectedCount('remove');
    });
    
    // Bulk priority buttons - set all items to the selected priority
    document.querySelectorAll('.bulk-priority-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const priority = btn.dataset.priority;

        // Update all priority dropdowns in the sync modal
        document.querySelectorAll('#sync-week-list .item-priority-select').forEach(select => {
          select.value = priority;
          // Also save to localStorage
          savePriorityToStorage(select);
        });

        // Visual feedback - highlight the clicked button
        document.querySelectorAll('.bulk-priority-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      });
    });
    
    // Sync modal priority changes back to localStorage
    document.getElementById('sync-week-list')?.addEventListener('change', (e) => {
      if (e.target.classList.contains('item-priority-select')) {
        savePriorityToStorage(e.target);
        // Also update the dashboard dropdown if it exists
        const url = e.target.dataset.url;
        const dashboardDropdown = document.querySelector(`.item-priority-dropdown[data-item-url="${url}"]`);
        if (dashboardDropdown) {
          dashboardDropdown.value = e.target.value;
          // Trigger styling update
          dashboardDropdown.classList.remove('priority-p0', 'priority-p1', 'priority-p2', 'priority-p3');
          dashboardDropdown.classList.add(`priority-${e.target.value.toLowerCase()}`);
        }
      }
    });
    
    // Helper to save priority to localStorage
    function savePriorityToStorage(selectEl) {
      const url = selectEl.dataset.url;
      if (!url) return;
      
      const ITEM_PRIORITY_KEY = `item_priorities_${window.location.pathname}`;
      try {
        const stored = localStorage.getItem(ITEM_PRIORITY_KEY);
        const priorities = stored ? JSON.parse(stored) : {};
        priorities[url] = selectEl.value;
        localStorage.setItem(ITEM_PRIORITY_KEY, JSON.stringify(priorities));
      } catch (e) {
        console.warn('Could not save priority:', e);
      }
    }
    
    // Close on outside click
    document.getElementById('selective-sync-modal')?.addEventListener('click', (e) => {
      if (e.target.id === 'selective-sync-modal') closeSelectiveSyncModal();
    });
    
    document.getElementById('selective-remove-modal')?.addEventListener('click', (e) => {
      if (e.target.id === 'selective-remove-modal') closeSelectiveRemoveModal();
    });
    
    // Preview modal handlers
    document.getElementById('close-preview-modal')?.addEventListener('click', closePreviewModal);
    document.getElementById('preview-back')?.addEventListener('click', closePreviewModal);
    document.getElementById('preview-confirm')?.addEventListener('click', () => {
      closePreviewModal();
      executeSelectiveSync();
    });
    document.getElementById('calendar-preview-modal')?.addEventListener('click', (e) => {
      if (e.target.id === 'calendar-preview-modal') closePreviewModal();
    });
    
    // Preview button handler
    document.getElementById('preview-sync-changes')?.addEventListener('click', showCalendarPreview);
    
    // Export iCal handler
    document.getElementById('export-ics-sync')?.addEventListener('click', () => {
      if (!currentSyncModalData) return;
      
      const { sprintKey, course } = currentSyncModalData;
      const selectedItems = getSelectedItemsFromModal();
      const priority = document.querySelector('input[name="sync-modal-priority"]:checked')?.value || 'P2';
      const courseName = course.toUpperCase();
      
      if (Object.keys(selectedItems).length === 0) {
        alert('No items selected to export.');
        return;
      }
      
      const events = buildEventsFromSelection(selectedItems, priority, courseName);
      const icsContent = generateICSFile(events);
      downloadICSFile(icsContent, `${sprintKey}-${courseName}.ics`);
      
      showToastNotification(`‚úì Downloaded ${events.length} events as ${sprintKey}-${courseName}.ics`, 'success');
    });
    
    // Update .ics file handler (File System Access API)
    document.getElementById('update-ics-file')?.addEventListener('click', async () => {
      if (!currentSyncModalData) return;
      
      // Check browser support
      if (!('showOpenFilePicker' in window)) {
        alert('Your browser does not support the File System Access API. Please use Chrome or Edge, or use the regular Export button instead.');
        return;
      }
      
      const { sprintKey, course } = currentSyncModalData;
      const selectedItems = getSelectedItemsFromModal();
      const priority = document.querySelector('input[name="sync-modal-priority"]:checked')?.value || 'P2';
      const courseName = course.toUpperCase();
      
      if (Object.keys(selectedItems).length === 0) {
        alert('No items selected to export.');
        return;
      }
      
      try {
        // Prompt user to select an existing .ics file to overwrite
        const [fileHandle] = await window.showOpenFilePicker({
          types: [{
            description: 'iCalendar Files',
            accept: { 'text/calendar': ['.ics', '.ical'] }
          }],
          multiple: false
        });
        
        // Validate file extension
        const fileName = fileHandle.name.toLowerCase();
        if (!fileName.endsWith('.ics') && !fileName.endsWith('.ical')) {
          alert('Unsupported file type. Please select a .ics or .ical file.');
          return;
        }
        
        // Generate new calendar content
        const events = buildEventsFromSelection(selectedItems, priority, courseName);
        const icsContent = generateICSFile(events);
        
        // Write to the selected file
        const writable = await fileHandle.createWritable();
        await writable.write(icsContent);
        await writable.close();
        
        showToastNotification(`‚úì Updated ${fileHandle.name} with ${events.length} events`, 'success');
        
      } catch (err) {
        // User cancelled the picker or permission denied
        if (err.name === 'AbortError') {
          // User cancelled - do nothing
          return;
        }
        console.error('Error updating .ics file:', err);
        alert('Failed to update the file. Make sure you have permission to write to this location.');
      }
    });
  }
</script>
